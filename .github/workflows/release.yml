name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump patch version
        id: bump
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          IFS='.' read -r major minor patch <<< "$CURRENT"
          NEW_VERSION="$major.$minor.$((patch + 1))"
          TAG="v$NEW_VERSION"

          # Update package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$NEW_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Update package-lock.json
          node -e "
            const fs = require('fs');
            const lock = JSON.parse(fs.readFileSync('package-lock.json', 'utf8'));
            lock.version = '$NEW_VERSION';
            if (lock.packages && lock.packages['']) lock.packages[''].version = '$NEW_VERSION';
            fs.writeFileSync('package-lock.json', JSON.stringify(lock, null, 2) + '\n');
          "

          # Update tauri.conf.json
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$NEW_VERSION';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2) + '\n');
          "

          # Update Cargo.toml
          sed -i "s/^version = \"$CURRENT\"/version = \"$NEW_VERSION\"/" src-tauri/Cargo.toml

          # Update Cargo.lock
          sed -i "0,/^version = \"$CURRENT\"/s//version = \"$NEW_VERSION\"/" src-tauri/Cargo.lock

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: bump version to $NEW_VERSION"
          git tag "$TAG"
          git push origin main --tags

          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  build:
    needs: bump-version
    strategy:
      matrix:
        include:
          - runner: macos-latest
            target: aarch64-apple-darwin
          - runner: macos-latest
            target: x86_64-apple-darwin
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install frontend dependencies
        run: npm ci

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.bump-version.outputs.tag }}
          releaseName: "Better MD ${{ needs.bump-version.outputs.tag }}"
          releaseBody: "Download the .dmg for your Mac architecture below."
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.target }}
